<!doctype html>
<html lang="ko">

<head>
	<meta charset="utf-8">
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="-1" />
	<meta http-equiv="Cache-Control" content="no-cache" />
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Go wasm</title>
	<link rel="shortcut icon" href="#" type="image/x-icon">
</head>

<body>
	<button onClick="rerunAll()" id="runButton" disabled>Re-Run</button>
	<button onClick="sayHi()">Say Hi</button>
	<button onClick="sayHelloworld()">Say Hello</button>
	<button onClick="myClassSUM()">Sum</button>
	<button onClick="getValue()">Get variable value</button>

	<div>Open <b>Developer console</b> in your browser</div>
</body>

<script>
	class MyClass {
		constructor() {
			this.a = 1
			this.b = 2
			this.c = 3
			this.d = 4
			this.e = 5
		}

		callWasmSUM() { return sum(this.a, this.b, this.c, this.d, this.e) }
	}
</script>

<script>
	function sayHi() {
		const r = hello("John")
		console.log(r)
	}

	function sayHelloworld() {
		const r = hello("World")
		console.log(r)
	}

	const myValue = { a: "haha" }
	const mycls = new MyClass()

	function myClassSUM() {
		console.log(mycls.callWasmSUM())
	}

	function getValue() {
		const objName = Object.keys({ mycls })[0]
		console.log(getvalue("mycls.a"))
	}
</script>

<!-- <script src="wasm_exec.js"></script> -->
<script src="wasm_exec_tinygo.js"></script>
<script>
	// const files = ["hello.wasm", "function.wasm"]
	const files = ["hello_tinygo.wasm", "function_tinygo.wasm"]

	// const go = new Go()
	const go = {}
	let mod = {}
	let inst = {}

	async function run(fname) {
		await go[fname].run(inst[fname])
		inst[fname] = await WebAssembly.instantiate(mod[fname], go[fname].importObject)
	}

	async function load(fname) {
		if (inst[fname]) { return }

		if (typeof WebAssembly !== "object") {
			alert("WebAssembly is not supported")
			return
		}

		let r
		const resp = await fetch(fname)

		if ('instantiateStreaming' in WebAssembly) {
			r = await WebAssembly.instantiateStreaming(resp, go[fname].importObject)
		} else {
			r = await WebAssembly.instantiate(await resp.arrayBuffer(), go[fname].importObject)
		}

		mod[fname] = r.module
		inst[fname] = r.instance
	}

	async function loadAll() {
		console.clear()
		for (let fname of files) {
			go[fname] = new Go()
			await load(fname)
			run(fname)
		}

		document.getElementById("runButton").disabled = false
	}

	async function rerunAll() {
		console.clear()
		for (let fname of files) {
			run(fname)
		}
	}

	loadAll()
</script>


</html>